syntax = "proto3";

package services.search.v1;

option go_package = "gitlab.com/xakpro/cg-proto/gen/go/services/search;searchv1";

import "google/protobuf/timestamp.proto";

service SearchService {
  // Search performs full-text search on requests
  rpc Search(SearchRequest) returns (SearchResponse);
  
  // Suggest returns search suggestions (autocomplete)
  rpc Suggest(SuggestRequest) returns (SuggestResponse);
  
  // Similar returns similar requests
  rpc Similar(SimilarRequest) returns (SimilarResponse);
  
  // Reindex triggers full or incremental reindex
  rpc Reindex(ReindexRequest) returns (ReindexResponse);
  
  // IndexRequest indexes a single request (internal, from Kafka events)
  rpc IndexRequest(IndexRequestRequest) returns (IndexRequestResponse);
  
  // DeleteRequest removes request from index (internal, from Kafka events)
  rpc DeleteFromIndex(DeleteFromIndexRequest) returns (DeleteFromIndexResponse);
}

enum RequestType {
  REQUEST_TYPE_UNSPECIFIED = 0;
  REQUEST_TYPE_REPAIR = 1;  // Ремонт
  REQUEST_TYPE_PARTS = 2;   // Запчасти
}

enum RequestStatus {
  REQUEST_STATUS_UNSPECIFIED = 0;
  REQUEST_STATUS_MODERATION = 1;
  REQUEST_STATUS_PUBLISHED = 2;
  REQUEST_STATUS_DELETED = 3;
}

enum SortBy {
  SORT_BY_UNSPECIFIED = 0;
  SORT_BY_RELEVANCE = 1;
  SORT_BY_DATE_DESC = 2;
  SORT_BY_DATE_ASC = 3;
}

// Request document for search results
message RequestDocument {
  int64 id = 1;
  RequestType type = 2;
  RequestStatus status = 3;
  int64 user_id = 4;
  
  // NSI references
  int64 group_id = 5;
  repeated int64 category_ids = 6;
  
  // Car info
  int64 car_make_id = 7;
  string car_make_name = 8;
  int64 car_model_id = 9;
  string car_model_name = 10;
  int32 year = 11;
  
  // Description
  string note = 12;
  repeated string photos = 13;
  
  // Location
  int64 city_id = 14;
  string city_name = 15;
  string address = 16;
  double latitude = 17;
  double longitude = 18;
  
  google.protobuf.Timestamp created_at = 19;
  google.protobuf.Timestamp published_at = 20;
}

// Facet bucket for aggregations
message FacetBucket {
  string key = 1;
  string name = 2;
  int64 count = 3;
}

// Facets (aggregations) for filtering
message Facets {
  repeated FacetBucket types = 1;
  repeated FacetBucket groups = 2;
  repeated FacetBucket categories = 3;
  repeated FacetBucket cities = 4;
  repeated FacetBucket car_makes = 5;
}

// Search
message SearchRequest {
  string query = 1;
  RequestType type = 2;
  int64 group_id = 3;
  int64 category_id = 4;
  int64 city_id = 5;
  int64 car_make_id = 6;
  int64 car_model_id = 7;
  int32 year = 8;
  int32 page = 9;
  int32 page_size = 10;
  SortBy sort_by = 11;
}

message SearchResponse {
  repeated RequestDocument requests = 1;
  int32 total = 2;
  Facets facets = 3;
}

// Suggest (autocomplete)
message SuggestRequest {
  string query = 1;
  int32 limit = 2;
}

message SuggestResponse {
  repeated string suggestions = 1;
}

// Similar requests
message SimilarRequest {
  int64 request_id = 1;
  int32 limit = 2;
}

message SimilarResponse {
  repeated RequestDocument requests = 1;
}

// Reindex
message ReindexRequest {
  bool full = 1;  // Full reindex or incremental
}

message ReindexResponse {
  int32 indexed = 1;
  int32 errors = 2;
  int64 duration_ms = 3;
}

// IndexRequest (internal)
message IndexRequestRequest {
  RequestDocument request = 1;
}

message IndexRequestResponse {
  bool success = 1;
}

// DeleteFromIndex (internal)
message DeleteFromIndexRequest {
  int64 request_id = 1;
}

message DeleteFromIndexResponse {
  bool success = 1;
}
