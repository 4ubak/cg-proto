syntax = "proto3";

package services.request.v1;

option go_package = "gitlab.com/xakpro/cg-proto/gen/go/services/request;requestv1";

import "google/protobuf/timestamp.proto";

service RequestService {
  // CreateRequest creates a new repair or parts request
  rpc CreateRequest(CreateRequestRequest) returns (CreateRequestResponse);
  
  // GetRequest returns request by ID
  rpc GetRequest(GetRequestRequest) returns (GetRequestResponse);
  
  // UpdateRequest updates a request
  rpc UpdateRequest(UpdateRequestRequest) returns (UpdateRequestResponse);
  
  // DeleteRequest deletes a request
  rpc DeleteRequest(DeleteRequestRequest) returns (DeleteRequestResponse);
  
  // ListRequests lists requests with filters
  rpc ListRequests(ListRequestsRequest) returns (ListRequestsResponse);
  
  // SearchRequests searches requests using Elasticsearch
  rpc SearchRequests(SearchRequestsRequest) returns (SearchRequestsResponse);
  
  // ChangeStatus changes request status (moderation, published, deleted)
  rpc ChangeStatus(ChangeStatusRequest) returns (ChangeStatusResponse);
  
  // GetUserRequests returns requests for a user
  rpc GetUserRequests(GetUserRequestsRequest) returns (GetUserRequestsResponse);
  
  // IncrementViews increments view count for a request
  rpc IncrementViews(IncrementViewsRequest) returns (IncrementViewsResponse);
  
  // GetSuggestions returns search suggestions
  rpc GetSuggestions(GetSuggestionsRequest) returns (GetSuggestionsResponse);
  
  // GetNewRequestsForOrganization returns list of new request IDs for organization
  rpc GetNewRequestsForOrganization(GetNewRequestsForOrganizationRequest) returns (GetNewRequestsForOrganizationResponse);
  
  // MarkRequestAsViewed marks request as viewed for organization
  rpc MarkRequestAsViewed(MarkRequestAsViewedRequest) returns (MarkRequestAsViewedResponse);
  
  // IsRequestNew checks if request is new for organization
  rpc IsRequestNew(IsRequestNewRequest) returns (IsRequestNewResponse);
}

enum RequestType {
  REQUEST_TYPE_UNSPECIFIED = 0;
  REQUEST_TYPE_REPAIR = 1;  // Ремонт
  REQUEST_TYPE_PARTS = 2;    // Запчасти
}

enum RequestStatus {
  REQUEST_STATUS_UNSPECIFIED = 0;
  REQUEST_STATUS_MODERATION = 1;
  REQUEST_STATUS_PUBLISHED = 2;
  REQUEST_STATUS_DELETED = 3;
}

message Request {
  int64 id = 1;
  RequestType type = 2;
  RequestStatus status = 3;
  int64 user_id = 4;
  
  // NSI (Группа → Категории)
  int64 group_id = 5;           // СТО, Кузовные, Запчасти
  repeated int64 category_ids = 6;  // Может быть несколько
  
  // Car details (для матчинга)
  int64 car_make_id = 7;
  int64 car_model_id = 8;
  optional int64 car_generation_id = 9;
  int32 year = 10;
  
  // Description
  string note = 11;
  repeated string photos = 12;
  
  // Location
  int64 city_id = 13;
  string address = 14;
  double latitude = 15;
  double longitude = 16;
  
  google.protobuf.Timestamp created_at = 17;
  google.protobuf.Timestamp updated_at = 18;
  optional google.protobuf.Timestamp published_at = 19;
}

// CreateRequest
message CreateRequestRequest {
  RequestType type = 1;
  int64 user_id = 2;
  
  int64 group_id = 3;
  repeated int64 category_ids = 4;
  
  int64 car_make_id = 5;
  int64 car_model_id = 6;
  optional int64 car_generation_id = 7;
  int32 year = 8;
  
  string note = 9;
  repeated string photos = 10;
  
  int64 city_id = 11;
  string address = 12;
  double latitude = 13;
  double longitude = 14;
  
  bool publish = 15;  // Если true, статус = "moderation"
}

message CreateRequestResponse {
  Request request = 1;
}

// GetRequest
message GetRequestRequest {
  int64 request_id = 1;
}

message GetRequestResponse {
  Request request = 1;
}

// UpdateRequest
message UpdateRequestRequest {
  int64 request_id = 1;
  int64 user_id = 2;
  
  optional string note = 3;
  repeated string photos = 4;
  
  optional string address = 5;
  optional double latitude = 6;
  optional double longitude = 7;
}

message UpdateRequestResponse {
  Request request = 1;
}

// DeleteRequest
message DeleteRequestRequest {
  int64 request_id = 1;
  int64 user_id = 2;
}

message DeleteRequestResponse {
  bool success = 1;
}

// ListRequests
message ListRequestsRequest {
  RequestType type = 1;
  RequestStatus status = 2;
  int64 user_id = 3;
  int64 group_id = 4;
  int64 category_id = 5;  // Фильтр по одной категории
  int64 city_id = 6;
  int64 car_make_id = 7;
  int32 page = 8;
  int32 page_size = 9;
  string sort_by = 10;  // created_at, published_at
}

message ListRequestsResponse {
  repeated Request requests = 1;
  int32 total = 2;
}

// SearchRequests
message SearchRequestsRequest {
  string query = 1;
  RequestType type = 2;
  int64 group_id = 3;
  repeated int64 category_ids = 4;
  int64 city_id = 5;
  int64 car_make_id = 6;
  int64 car_model_id = 7;
  int32 year_min = 8;
  int32 year_max = 9;
  int32 page = 10;
  int32 page_size = 11;
}

message SearchRequestsResponse {
  repeated Request requests = 1;
  int32 total = 2;
}

// ChangeStatus
message ChangeStatusRequest {
  int64 request_id = 1;
  RequestStatus status = 2;
  int64 user_id = 3;
}

message ChangeStatusResponse {
  Request request = 1;
}

// GetUserRequests
message GetUserRequestsRequest {
  int64 user_id = 1;
  RequestStatus status = 2;
  int32 page = 3;
  int32 page_size = 4;
}

message GetUserRequestsResponse {
  repeated Request requests = 1;
  int32 total = 2;
}

// IncrementViews
message IncrementViewsRequest {
  int64 request_id = 1;
}

message IncrementViewsResponse {
  bool success = 1;
}

// GetSuggestions
message GetSuggestionsRequest {
  string query = 1;
  int32 limit = 2;
}

message GetSuggestionsResponse {
  repeated string suggestions = 1;
}

// GetNewRequestsForOrganization
message GetNewRequestsForOrganizationRequest {
  string organization_id = 1;  // UUID from organization-service
}

message GetNewRequestsForOrganizationResponse {
  repeated int64 request_ids = 1;
}

// MarkRequestAsViewed
message MarkRequestAsViewedRequest {
  int64 request_id = 1;
  string organization_id = 2;  // UUID from organization-service
}

message MarkRequestAsViewedResponse {
  bool success = 1;
}

// IsRequestNew
message IsRequestNewRequest {
  int64 request_id = 1;
  string organization_id = 2;  // UUID from organization-service
}

message IsRequestNewResponse {
  bool is_new = 1;
}

