syntax = "proto3";

package users.auth.v1;

option go_package = "gitlab.com/xakpro/cg-proto/gen/go/users/auth;authv1";

import "google/protobuf/timestamp.proto";

service AuthService {
  // SendCode sends verification code to phone number
  rpc SendCode(SendCodeRequest) returns (SendCodeResponse);
  
  // VerifyCode verifies the code and returns tokens
  rpc VerifyCode(VerifyCodeRequest) returns (VerifyCodeResponse);
  
  // RefreshToken refreshes access token using refresh token
  rpc RefreshToken(RefreshTokenRequest) returns (RefreshTokenResponse);
  
  // Logout invalidates refresh token
  rpc Logout(LogoutRequest) returns (LogoutResponse);
  
  // ValidateToken validates access token (internal use)
  rpc ValidateToken(ValidateTokenRequest) returns (ValidateTokenResponse);
  
  // GetSessions returns active sessions for user
  rpc GetSessions(GetSessionsRequest) returns (GetSessionsResponse);
}

message SendCodeRequest {
  string phone = 1;
  string device_id = 2;
}

message SendCodeResponse {
  bool success = 1;
  int32 retry_after = 2;  // seconds to wait before next request
  string message = 3;
}

message VerifyCodeRequest {
  string phone = 1;
  string code = 2;
  string device_id = 3;
  string invite_code = 4;  // optional: join organization on registration
}

message VerifyCodeResponse {
  string access_token = 1;
  string refresh_token = 2;
  google.protobuf.Timestamp expires_at = 3;
  User user = 4;
  bool is_new_user = 5;
}

message RefreshTokenRequest {
  string refresh_token = 1;
}

message RefreshTokenResponse {
  string access_token = 1;
  string refresh_token = 2;
  google.protobuf.Timestamp expires_at = 3;
}

message LogoutRequest {
  string refresh_token = 1;
}

message LogoutResponse {
  bool success = 1;
}

message ValidateTokenRequest {
  string access_token = 1;
}

message ValidateTokenResponse {
  bool valid = 1;
  int64 user_id = 2;
  string phone = 3;
}

message GetSessionsRequest {
  int64 user_id = 1;
}

message GetSessionsResponse {
  repeated Session sessions = 1;
}

message User {
  int64 id = 1;
  string phone = 2;
  string name = 3;
  string avatar = 4;
  google.protobuf.Timestamp created_at = 5;
  google.protobuf.Timestamp updated_at = 6;
}

message Session {
  string id = 1;
  string device_id = 2;
  string user_agent = 3;
  string ip = 4;
  google.protobuf.Timestamp created_at = 5;
  google.protobuf.Timestamp last_used_at = 6;
}
